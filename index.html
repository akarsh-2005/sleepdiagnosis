<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SleepGuard - Sleep Analysis & Environment Optimization</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
            margin-bottom: 20px;
        }

        .card-header {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .card-body {
            padding: 30px;
        }

        .tab-buttons {
            display: flex;
            background: #f1f3f4;
            border-radius: 8px;
            padding: 4px;
            margin-bottom: 20px;
        }

        .tab-button {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: transparent;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .tab-button.active {
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .upload-area {
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: #5a67d8;
            background: #f7fafc;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
        }

        .btn-full {
            width: 100%;
            justify-content: center;
        }

        .result-card {
            background: #f7fafc;
            border-left: 4px solid #667eea;
            padding: 20px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }

        .result-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .disclaimer {
            background: #fed7d7;
            border: 1px solid #feb2b2;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }

        .disclaimer-title {
            font-weight: bold;
            color: #c53030;
            margin-bottom: 5px;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .hidden {
            display: none;
        }

        #file-input, #photo-input {
            display: none;
        }

        .file-name {
            margin-top: 10px;
            color: #4a5568;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Sleep<span style="color: #9f7aea;">Guard</span></h1>
            <p>AI-powered sleep analysis through environment optimization & snore detection</p>
        </div>

        <div class="card">
            <div class="card-header">
                <h2>Sleep Analysis Input</h2>
                <p>Upload your bedroom photo for sleep environment advice or audio for snore analysis</p>
            </div>
            <div class="card-body">
                <div class="tab-buttons">
                    <button class="tab-button active" onclick="switchTab('space')">üè† Sleep Space</button>
                    <button class="tab-button" onclick="switchTab('record')">üéôÔ∏è Auto Record</button>
                    <button class="tab-button" onclick="switchTab('upload')">üìÅ Upload Audio</button>
                </div>

                <div id="space-tab" class="tab-content active">
                    <div class="upload-area" onclick="document.getElementById('photo-input').click()">
                        <div style="font-size: 48px; margin-bottom: 15px;">üè†</div>
                        <p style="margin: 10px 0;"><strong>Upload Your Bedroom Photo</strong></p>
                        <p style="color: #718096; margin-bottom: 10px;">Get personalized sleep environment advice</p>
                        <input type="file" id="photo-input" accept="image/*" onchange="handlePhotoSelect(event)">
                        <div id="photo-preview" style="margin-top: 15px; display: none;">
                            <img id="preview-image" style="max-width: 100%; max-height: 200px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <p id="photo-name" class="file-name" style="margin-top: 10px;"></p>
                        </div>
                        <p style="font-size: 12px; color: #a0aec0; margin-top: 10px;">Supports JPG, PNG, WebP images</p>
                    </div>
                </div>

                <div id="record-tab" class="tab-content">
                    <div class="upload-area">
                        <div style="font-size: 48px; margin-bottom: 15px;">üéôÔ∏è</div>
                        <p style="margin: 10px 0;"><strong>Auto Record Snoring</strong></p>
                        <p style="color: #718096; margin-bottom: 15px;">Automatically detect and record snoring sounds</p>
                        
                        <div id="recording-controls" style="margin: 20px 0;">
                            <button id="start-recording-btn" class="btn" onclick="startAutoRecording()" style="background: #48bb78; color: white; margin: 5px;">
                                üî¥ Start Auto Recording
                            </button>
                            <button id="stop-recording-btn" class="btn" onclick="stopAutoRecording()" style="background: #e53e3e; color: white; margin: 5px; display: none;">
                                ‚èπÔ∏è Stop Recording
                            </button>
                        </div>
                        
                        <div id="recording-status" style="display: none; margin: 15px 0; padding: 15px; background: #f0fff4; border-radius: 8px; border-left: 4px solid #48bb78;">
                            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                <div class="recording-indicator" style="width: 12px; height: 12px; background: #e53e3e; border-radius: 50%; margin-right: 10px; animation: pulse 1s infinite;"></div>
                                <strong style="color: #2d3748;">Recording in progress...</strong>
                            </div>
                            <p style="margin: 5px 0; color: #4a5568;">Duration: <span id="recording-duration">00:00</span></p>
                            <p style="margin: 5px 0; color: #4a5568;">Snoring detected: <span id="snoring-detected">0</span> times</p>
                            <div style="margin-top: 10px;">
                                <div style="background: #e2e8f0; border-radius: 4px; height: 8px; overflow: hidden;">
                                    <div id="volume-bar" style="background: #48bb78; height: 100%; width: 0%; transition: width 0.1s;"></div>
                                </div>
                                <small style="color: #718096;">Audio Level</small>
                            </div>
                        </div>
                        
                        <div id="recording-settings" style="margin: 20px 0; padding: 15px; background: #f7fafc; border-radius: 8px;">
                            <h4 style="margin: 0 0 10px 0; color: #4a5568;">Recording Settings</h4>
                            <div style="margin: 10px 0;">
                                <label style="display: block; margin-bottom: 5px; color: #4a5568;">Sensitivity:</label>
                                <input type="range" id="sensitivity-slider" min="10" max="90" value="50" style="width: 100%;">
                                <small style="color: #718096;">Adjust how sensitive the recording is to sounds</small>
                            </div>
                            <div style="margin: 10px 0;">
                                <label style="display: block; margin-bottom: 5px; color: #4a5568;">Max Duration:</label>
                                <select id="max-duration" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 4px;">
                                    <option value="300">5 minutes</option>
                                    <option value="600">10 minutes</option>
                                    <option value="1800" selected>30 minutes</option>
                                    <option value="3600">1 hour</option>
                                    <option value="7200">2 hours</option>
                                </select>
                            </div>
                        </div>
                        
                        <div id="recorded-audio-preview" style="display: none; margin: 20px 0; padding: 15px; background: #edf2f7; border-radius: 8px;">
                            <h4 style="margin: 0 0 10px 0; color: #4a5568;">üéß Recorded Audio</h4>
                            <audio id="recorded-audio" controls style="width: 100%; margin: 10px 0;"></audio>
                            <p style="color: #4a5568; margin: 5px 0;">Duration: <span id="final-duration"></span></p>
                            <p style="color: #4a5568; margin: 5px 0;">Total snoring events: <span id="final-snoring-count"></span></p>
                        </div>
                        
                        <p style="font-size: 12px; color: #a0aec0; margin-top: 10px;">Microphone access required. Recording automatically stops when snoring is detected.</p>
                    </div>
                </div>

                <div id="upload-tab" class="tab-content">
                    <div class="upload-area" onclick="document.getElementById('file-input').click()">
                        <div style="font-size: 48px; margin-bottom: 15px;">üìÅ</div>
                        <p style="margin: 10px 0;"><strong>Choose an audio file</strong></p>
                        <p style="color: #718096;">For traditional snore analysis</p>
                        <input type="file" id="file-input" accept=".wav,.mp3" onchange="handleFileSelect(event)">
                        <div id="file-name" class="file-name hidden"></div>
                        <p style="font-size: 12px; color: #a0aec0; margin-top: 10px;">Supports .wav and .mp3 files</p>
                    </div>
                </div>

                <button id="analyze-btn" class="btn btn-full hidden" onclick="analyzeContent()" style="margin-top: 20px;">
                    <span id="analyze-text">üîç Analyze Sleep Space</span>
                </button>
            </div>
        </div>

        <div id="loading-card" class="card hidden">
            <div class="card-body">
                <div class="loading">
                    <div class="spinner"></div>
                    <h3>Analyzing your content...</h3>
                    <p>This may take a moment</p>
                </div>
            </div>
        </div>

        <div id="results-card" class="card hidden">
            <div class="card-body">
                <div id="results-content"></div>
                <div class="disclaimer">
                    <div class="disclaimer-title">‚ö† Medical Disclaimer</div>
                    <p>This tool provides general advice and should not replace professional medical consultation. For persistent sleep issues or suspected sleep disorders, please consult a healthcare provider.</p>
                </div>
                <button class="btn btn-full" onclick="resetApp()" style="margin-top: 20px;">
                    üîÑ Start Over
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentAudioFile = null;
        let currentPhotoFile = null;
        let currentRecordedAudio = null;
        let analysisMode = 'space';
        
        // Recording variables
        let mediaRecorder = null;
        let audioStream = null;
        let recordingData = [];
        let recordingStartTime = null;
        let recordingTimer = null;
        let audioContext = null;
        let analyser = null;
        let snoringDetectionCount = 0;
        let isRecording = false;

        function switchTab(tab) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tab + '-tab').classList.add('active');
            
            analysisMode = tab;
            const analyzeText = document.getElementById('analyze-text');
            const analyzeBtn = document.getElementById('analyze-btn');
            
            if (tab === 'space') {
                analyzeText.textContent = 'üîç Analyze Sleep Space';
                analyzeBtn.style.display = currentPhotoFile ? 'block' : 'none';
            } else if (tab === 'record') {
                analyzeText.textContent = 'üîç Analyze Recorded Audio';
                analyzeBtn.style.display = currentRecordedAudio ? 'block' : 'none';
            } else {
                analyzeText.textContent = 'üîç Analyze Snore Audio';
                analyzeBtn.style.display = currentAudioFile ? 'block' : 'none';
            }
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                if (file.type === 'audio/wav' || file.type === 'audio/mpeg') {
                    currentAudioFile = file;
                    document.getElementById('file-name').textContent = file.name;
                    document.getElementById('file-name').classList.remove('hidden');
                    document.getElementById('analyze-btn').classList.remove('hidden');
                } else {
                    alert('Please upload a .wav or .mp3 file.');
                }
            }
        }

        function handlePhotoSelect(event) {
            const file = event.target.files[0];
            if (file) {
                if (file.type.startsWith('image/')) {
                    currentPhotoFile = file;
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('preview-image').src = e.target.result;
                        document.getElementById('photo-name').textContent = file.name;
                        document.getElementById('photo-preview').style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                    
                    document.getElementById('analyze-btn').classList.remove('hidden');
                } else {
                    alert('Please upload an image file (JPG, PNG, WebP).');
                }
            }
        }

        async function startAutoRecording() {
            try {
                // Request microphone access
                audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // Setup audio analysis
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioContext.createMediaStreamSource(audioStream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                source.connect(analyser);
                
                // Setup MediaRecorder
                recordingData = [];
                mediaRecorder = new MediaRecorder(audioStream);
                
                mediaRecorder.ondataavailable = function(event) {
                    if (event.data.size > 0) {
                        recordingData.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = function() {
                    const audioBlob = new Blob(recordingData, { type: 'audio/wav' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    
                    document.getElementById('recorded-audio').src = audioUrl;
                    document.getElementById('recorded-audio-preview').style.display = 'block';
                    
                    // Convert to File object for analysis
                    currentRecordedAudio = new File([audioBlob], 'recorded_snoring.wav', { type: 'audio/wav' });
                    
                    const duration = Math.floor((Date.now() - recordingStartTime) / 1000);
                    document.getElementById('final-duration').textContent = formatTime(duration);
                    document.getElementById('final-snoring-count').textContent = snoringDetectionCount;
                    
                    // Show analyze button
                    document.getElementById('analyze-btn').classList.remove('hidden');
                };
                
                // Start recording
                recordingStartTime = Date.now();
                snoringDetectionCount = 0;
                isRecording = true;
                
                mediaRecorder.start(1000); // Collect data every second
                
                // Update UI
                document.getElementById('start-recording-btn').style.display = 'none';
                document.getElementById('stop-recording-btn').style.display = 'inline-block';
                document.getElementById('recording-status').style.display = 'block';
                
                // Start monitoring
                startAudioMonitoring();
                
            } catch (error) {
                console.error('Error accessing microphone:', error);
                alert('Could not access microphone. Please ensure microphone permissions are enabled.');
            }
        }
        
        function stopAutoRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
            }
            
            if (audioStream) {
                audioStream.getTracks().forEach(track => track.stop());
            }
            
            if (audioContext) {
                audioContext.close();
            }
            
            if (recordingTimer) {
                clearInterval(recordingTimer);
            }
            
            // Update UI
            document.getElementById('start-recording-btn').style.display = 'inline-block';
            document.getElementById('stop-recording-btn').style.display = 'none';
            document.getElementById('recording-status').style.display = 'none';
        }
        
        function startAudioMonitoring() {
            const sensitivity = document.getElementById('sensitivity-slider').value / 100;
            const maxDuration = parseInt(document.getElementById('max-duration').value) * 1000;
            
            recordingTimer = setInterval(() => {
                if (!isRecording) return;
                
                // Update duration
                const elapsed = Date.now() - recordingStartTime;
                document.getElementById('recording-duration').textContent = formatTime(Math.floor(elapsed / 1000));
                
                // Analyze audio level
                if (analyser) {
                    const dataArray = new Uint8Array(analyser.frequencyBinCount);
                    analyser.getByteFrequencyData(dataArray);
                    
                    // Calculate average volume
                    const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
                    const volumePercent = (average / 255) * 100;
                    
                    // Update volume bar
                    document.getElementById('volume-bar').style.width = volumePercent + '%';
                    
                    // Simple snoring detection (detect sustained loud sounds)
                    if (volumePercent > (sensitivity * 80)) {
                        snoringDetectionCount++;
                        document.getElementById('snoring-detected').textContent = snoringDetectionCount;
                    }
                }
                
                // Check max duration
                if (elapsed >= maxDuration) {
                    stopAutoRecording();
                }
                
            }, 100);
        }
        
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        async function analyzeContent() {
            if (analysisMode === 'space') {
                await analyzeSleepSpace();
            } else if (analysisMode === 'record') {
                await analyzeRecordedAudio();
            } else {
                await analyzeAudio();
            }
        }

        async function analyzeSleepSpace() {
            if (!currentPhotoFile) {
                alert('Please upload a bedroom photo first.');
                return;
            }

            document.getElementById('loading-card').classList.remove('hidden');
            document.getElementById('results-card').classList.add('hidden');

            try {
                await new Promise(resolve => setTimeout(resolve, 2000));
                const advice = generateSleepAdvice();
                displaySleepAdvice(advice);
            } catch (error) {
                console.error('Error:', error);
                alert('Analysis failed. Please try again.');
            } finally {
                document.getElementById('loading-card').classList.add('hidden');
            }
        }

        function generateSleepAdvice() {
            const scenarios = [
                {
                    title: "Lighting Environment",
                    issue: "Room appears to have bright lighting",
                    advice: "Consider using blackout curtains or an eye mask. Dim lighting 1-2 hours before bedtime helps your body produce melatonin naturally.",
                    icon: "üí°",
                    severity: "moderate"
                },
                {
                    title: "Pillow Support",
                    issue: "Pillows appear flat or unsupportive",
                    advice: "Invest in a contoured or memory foam pillow that keeps your neck aligned. Proper neck support can reduce airway obstruction during sleep.",
                    icon: "üò¥",
                    severity: "high"
                },
                {
                    title: "Room Organization",
                    issue: "Bedroom appears cluttered",
                    advice: "A clean, organized bedroom promotes better sleep quality. Consider removing electronic devices and creating a calming environment.",
                    icon: "üßπ",
                    severity: "low"
                },
                {
                    title: "Optimal Sleep Environment",
                    issue: "Your bedroom looks well-organized",
                    advice: "Great job! Your sleep environment appears conducive to quality rest. Maintain this setup and ensure room temperature stays between 60-67¬∞F.",
                    icon: "‚úÖ",
                    severity: "none"
                }
            ];
            
            const numAdvice = Math.random() > 0.6 ? 2 : 1;
            const selectedAdvice = [];
            const usedIndices = new Set();
            
            for (let i = 0; i < numAdvice; i++) {
                let randomIndex;
                do {
                    randomIndex = Math.floor(Math.random() * scenarios.length);
                } while (usedIndices.has(randomIndex));
                
                usedIndices.add(randomIndex);
                selectedAdvice.push(scenarios[randomIndex]);
            }
            
            return selectedAdvice;
        }

        function displaySleepAdvice(adviceList) {
            let adviceHtml = '';
            
            adviceList.forEach(advice => {
                const severityColor = {
                    'high': '#e53e3e',
                    'moderate': '#ed8936', 
                    'low': '#38b2ac',
                    'none': '#48bb78'
                }[advice.severity];
                
                const severityBg = {
                    'high': '#fed7d7',
                    'moderate': '#fef5e7',
                    'low': '#e6fffa', 
                    'none': '#f0fff4'
                }[advice.severity];
                
                adviceHtml += `
                    <div style="background: ${severityBg}; border-left: 4px solid ${severityColor}; padding: 20px; margin: 15px 0; border-radius: 8px;">
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <span style="font-size: 24px; margin-right: 10px;">${advice.icon}</span>
                            <h4 style="margin: 0; color: #2d3748; font-size: 18px;">${advice.title}</h4>
                        </div>
                        <p style="margin: 8px 0; color: #4a5568; font-weight: 500;">${advice.issue}</p>
                        <p style="margin: 0; color: #2d3748; line-height: 1.5;">${advice.advice}</p>
                    </div>
                `;
            });
            
            const resultsHtml = `
                <div class="result-card">
                    <div class="result-title">üè† Sleep Environment Analysis</div>
                    <p style="margin: 15px 0; color: #4a5568;">
                        Based on your bedroom photo, here are personalized recommendations to optimize your sleep environment:
                    </p>
                    ${adviceHtml}
                    <div style="margin-top: 20px; padding: 15px; background: #edf2f7; border-radius: 8px;">
                        <p style="margin: 0; font-size: 14px; color: #4a5568;">
                            <strong>üìù Note:</strong> These suggestions are based on visual analysis of your bedroom setup. 
                            For persistent sleep issues or suspected sleep apnea, please consult a healthcare professional.
                        </p>
                    </div>
                </div>
            `;

            document.getElementById('results-content').innerHTML = resultsHtml;
            document.getElementById('results-card').classList.remove('hidden');
        }

        async function analyzeRecordedAudio() {
            if (!currentRecordedAudio) {
                alert('Please record audio first.');
                return;
            }

            document.getElementById('loading-card').classList.remove('hidden');
            document.getElementById('results-card').classList.add('hidden');

            try {
                const formData = new FormData();
                formData.append('audio', currentRecordedAudio);

                const response = await fetch('http://localhost:8000/analyze', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`Analysis failed: ${response.statusText}`);
                }

                const result = await response.json();
                displayAudioResults(result);

            } catch (error) {
                console.error('Error:', error);
                alert('Audio analysis failed. Please make sure the backend server is running on port 8000.');
            } finally {
                document.getElementById('loading-card').classList.add('hidden');
            }
        }

        async function analyzeAudio() {
            if (!currentAudioFile) {
                alert('Please upload an audio file first.');
                return;
            }

            document.getElementById('loading-card').classList.remove('hidden');
            document.getElementById('results-card').classList.add('hidden');

            try {
                const formData = new FormData();
                formData.append('audio', currentAudioFile);

                const response = await fetch('http://localhost:8000/analyze', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`Analysis failed: ${response.statusText}`);
                }

                const result = await response.json();
                displayAudioResults(result);

            } catch (error) {
                console.error('Error:', error);
                alert('Audio analysis failed. Please make sure the backend server is running on port 8000.');
            } finally {
                document.getElementById('loading-card').classList.add('hidden');
            }
        }

        function displayAudioResults(result) {
            const isApnea = result.label === 'likely_apnea';
            const confidence = Math.round(result.probability * 100);
            
            console.log('Full API result:', result); // Debug log
            console.log('Spectrogram data:', result.spectrogram); // Debug log
            
            // Build spectrogram section if available
            let spectrogramHtml = '';
            if (result.spectrogram && Object.keys(result.spectrogram).length > 0) {
                console.log('Processing spectrogram data...'); // Debug log
                console.log('Frequency analysis:', result.spectrogram.frequency_analysis); // Debug log
                
                if (result.spectrogram.image_base64) {
                    spectrogramHtml = `
                        <div style="margin: 20px 0; border-top: 1px solid #e2e8f0; padding-top: 20px;">
                            <h4 style="margin-bottom: 15px; color: #4a5568; font-size: 18px;">üìä Frequency Analysis & Spectrogram</h4>
                            <div style="text-align: center; margin-bottom: 15px; background: #f7fafc; padding: 15px; border-radius: 8px;">
                                <img src="data:image/png;base64,${result.spectrogram.image_base64}" 
                                     alt="Audio Spectrogram" 
                                     style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                                <p style="margin-top: 10px; font-size: 12px; color: #718096; font-style: italic;">
                                    Spectrogram showing frequency content over time and average frequency spectrum
                                </p>
                            </div>
                            ${result.spectrogram.frequency_analysis ? generateFrequencyAnalysis(result.spectrogram.frequency_analysis) : '<p style="color: #e53e3e;">‚ùå No frequency analysis data available</p>'}
                        </div>
                    `;
                } else if (result.spectrogram.error) {
                    spectrogramHtml = `
                        <div style="margin: 20px 0; border-top: 1px solid #e2e8f0; padding-top: 20px;">
                            <h4 style="margin-bottom: 15px; color: #4a5568;">üìä Frequency Analysis</h4>
                            <div style="background: #fed7d7; border: 1px solid #feb2b2; border-radius: 8px; padding: 15px;">
                                <p style="margin: 0; color: #c53030;">‚ö† Spectrogram generation failed: ${result.spectrogram.error}</p>
                            </div>
                        </div>
                    `;
                } else {
                    spectrogramHtml = `
                        <div style="margin: 20px 0; border-top: 1px solid #e2e8f0; padding-top: 20px;">
                            <h4 style="margin-bottom: 15px; color: #4a5568;">üìä Frequency Analysis</h4>
                            <div style="background: #fef5e7; border: 1px solid #f6ad55; border-radius: 8px; padding: 15px;">
                                <p style="margin: 0; color: #c05621;">üìà Frequency analysis completed, but visual spectrogram not available</p>
                            </div>
                        </div>
                    `;
                }
            } else {
                console.log('No spectrogram data found in result'); // Debug log
                spectrogramHtml = `
                    <div style="margin: 20px 0; border-top: 1px solid #e2e8f0; padding-top: 20px;">
                        <h4 style="margin-bottom: 15px; color: #4a5568;">üìä Frequency Analysis</h4>
                        <div style="background: #fed7d7; border: 1px solid #feb2b2; border-radius: 8px; padding: 15px;">
                            <p style="margin: 0; color: #c53030;">‚ùå No spectrogram data received from backend</p>
                        </div>
                    </div>
                `;
            }
            
            const resultsHtml = `
                <div class="result-card">
                    <div class="result-title">${isApnea ? 'Likely Sleep Apnea' : 'Normal Snoring'}</div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin: 15px 0;">
                        <span>Confidence Score:</span>
                        <strong style="font-size: 18px; color: #667eea;">${confidence}%</strong>
                    </div>
                    <div style="background: #e2e8f0; border-radius: 10px; height: 20px; overflow: hidden; margin: 10px 0;">
                        <div style="background: #667eea; height: 100%; width: ${confidence}%; transition: width 0.5s ease;"></div>
                    </div>
                    <p style="margin-top: 15px; color: #4a5568;">
                        ${isApnea 
                            ? 'The analysis indicates potential sleep apnea patterns in your audio recording.' 
                            : 'The analysis suggests normal snoring patterns without signs of sleep apnea.'}
                    </p>
                    <p style="margin-top: 10px; font-size: 14px; color: #718096;">
                        Note: ${result.note || 'Analysis completed successfully'}
                    </p>
                    ${spectrogramHtml}
                </div>
            `;

            document.getElementById('results-content').innerHTML = resultsHtml;
            document.getElementById('results-card').classList.remove('hidden');
        }

        function generateFrequencyAnalysis(frequencyData) {
            console.log('generateFrequencyAnalysis called with:', frequencyData); // Debug log
            
            if (!frequencyData || typeof frequencyData !== 'object') {
                console.log('No valid frequency data provided'); // Debug log
                return '<p style="color: #e53e3e;">‚ùå No frequency analysis data available</p>';
            }
            
            let analysisHtml = '<div style="margin-top: 15px; background: #f8f9fa; padding: 15px; border-radius: 8px;">';
            analysisHtml += '<h5 style="margin: 0 0 10px 0; color: #495057;">üéµ Frequency Band Analysis:</h5>';
            
            const bands = [
                { name: 'Low Frequency', range: '0-100 Hz', key: 'low_freq_energy', color: '#28a745', description: 'Deep breathing, body movements' },
                { name: 'Mid Frequency', range: '100-500 Hz', key: 'mid_freq_energy', color: '#ffc107', description: 'Primary snoring range' },
                { name: 'High Frequency', range: '>500 Hz', key: 'high_freq_energy', color: '#dc3545', description: 'Airway turbulence, apnea events' }
            ];
            
            // Extract energy values (these are in dB, so they can be negative)
            const lowEnergy = parseFloat(frequencyData.low_freq_energy) || 0;
            const midEnergy = parseFloat(frequencyData.mid_freq_energy) || 0;
            const highEnergy = parseFloat(frequencyData.high_freq_energy) || 0;
            
            console.log('Energy values (dB):', {lowEnergy, midEnergy, highEnergy}); // Debug log
            
            // Convert dB values to relative scale for percentage calculation
            // Find the maximum (least negative) value to use as reference
            const maxEnergy = Math.max(lowEnergy, midEnergy, highEnergy);
            const minEnergy = Math.min(lowEnergy, midEnergy, highEnergy);
            const range = maxEnergy - minEnergy;
            
            if (range === 0) {
                return '<p style="color: #f59e0b;">‚ö† All frequency bands have equal energy</p>';
            }
            
            bands.forEach(band => {
                const rawValue = parseFloat(frequencyData[band.key]) || 0;
                // Normalize to 0-100 scale where highest energy = 100%
                const normalizedValue = range > 0 ? ((rawValue - minEnergy) / range) : 0;
                const percentage = Math.round(normalizedValue * 100);
                
                console.log(`${band.name}: ${rawValue} dB -> ${percentage}%`); // Debug log
                
                analysisHtml += `
                    <div style="margin: 8px 0; display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <strong style="color: ${band.color};">${band.name}</strong> (${band.range})
                            <br><small style="color: #6c757d;">${band.description}</small>
                            <br><small style="color: #9ca3af; font-style: italic;">${rawValue.toFixed(1)} dB</small>
                        </div>
                        <div style="text-align: right;">
                            <div style="background: #e9ecef; border-radius: 10px; width: 100px; height: 8px; display: inline-block; position: relative;">
                                <div style="background: ${band.color}; height: 100%; width: ${percentage}%; border-radius: 10px;"></div>
                            </div>
                            <div style="font-size: 12px; color: #495057; margin-top: 2px;">${percentage}%</div>
                        </div>
                    </div>
                `;
            });
            
            // Add dominant frequency information if available
            if (frequencyData.dominant_frequency) {
                const dominantFreq = parseFloat(frequencyData.dominant_frequency) || 0;
                analysisHtml += `
                    <div style="margin-top: 10px; padding: 10px; background: #e3f2fd; border-radius: 6px;">
                        <small style="color: #1976d2;">
                            <strong>üéØ Dominant Frequency:</strong> ${Math.round(dominantFreq)} Hz
                        </small>
                    </div>
                `;
            }
            
            analysisHtml += '</div>';
            
            // Add frequency interpretation using the normalized values
            const interpretation = generateFrequencyInterpretation({
                low_freq_energy: ((lowEnergy - minEnergy) / range),
                mid_freq_energy: ((midEnergy - minEnergy) / range),
                high_freq_energy: ((highEnergy - minEnergy) / range)
            });
            if (interpretation) {
                analysisHtml += interpretation;
            }
            
            return analysisHtml;
        }

        function generateFrequencyInterpretation(frequencyData) {
            if (!frequencyData) return '';
            
            const highFreq = frequencyData.high_freq_energy || 0;
            const midFreq = frequencyData.mid_freq_energy || 0;
            const lowFreq = frequencyData.low_freq_energy || 0;
            const totalEnergy = highFreq + midFreq + lowFreq;
            
            if (totalEnergy <= 0) return '';
            
            const highPct = (highFreq / totalEnergy);
            const midPct = (midFreq / totalEnergy);
            const lowPct = (lowFreq / totalEnergy);
            
            let interpretation = '';
            let alertClass = 'info';
            let alertColor = '#17a2b8';
            let alertBg = '#d1ecf1';
            
            if (highPct > 0.4) {
                interpretation = '‚ö† High frequency content detected - may indicate airway obstruction or irregular breathing patterns.';
                alertClass = 'warning';
                alertColor = '#856404';
                alertBg = '#fff3cd';
            } else if (midPct > 0.5) {
                interpretation = 'üìä Predominantly mid-frequency snoring - typical snoring patterns detected.';
                alertClass = 'success';
                alertColor = '#155724';
                alertBg = '#d4edda';
            } else if (lowPct > 0.5) {
                interpretation = 'üí§ Low frequency dominance - may indicate deep sleep breathing or body movement sounds.';
            }
            
            if (interpretation) {
                return `
                    <div style="margin-top: 15px; padding: 12px; background: ${alertBg}; border: 1px solid ${alertColor}; border-radius: 8px;">
                        <p style="margin: 0; color: ${alertColor}; font-size: 14px;">${interpretation}</p>
                    </div>
                `;
            }
            
            return '';
        }

        function resetApp() {
            currentAudioFile = null;
            currentPhotoFile = null;
            currentRecordedAudio = null;

            // Stop any ongoing recording
            if (isRecording) {
                stopAutoRecording();
            }

            document.getElementById('file-name').classList.add('hidden');
            document.getElementById('photo-preview').style.display = 'none';
            document.getElementById('recorded-audio-preview').style.display = 'none';
            document.getElementById('analyze-btn').classList.add('hidden');
            document.getElementById('results-card').classList.add('hidden');
            document.getElementById('loading-card').classList.add('hidden');
            document.getElementById('file-input').value = '';
            document.getElementById('photo-input').value = '';
            
            // Reset recording UI
            document.getElementById('start-recording-btn').style.display = 'inline-block';
            document.getElementById('stop-recording-btn').style.display = 'none';
            document.getElementById('recording-status').style.display = 'none';
            snoringDetectionCount = 0;
        }

        window.onload = async function() {
            try {
                const response = await fetch('http://localhost:8000/health');
                if (response.ok) {
                    console.log('Backend connected successfully');
                } else {
                    console.warn('Backend health check failed');
                }
            } catch (error) {
                console.warn('Could not connect to backend:', error);
            }
        };
    </script>
</body>
</html>