<!DOCTYPE html>
<html>
<head>
    <title>SleepApnea Auto-Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f0f0f0; }
        .test-container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .pass { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .fail { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .log { background: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; margin: 10px 0; font-family: monospace; white-space: pre-wrap; max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>SleepApnea Frontend Auto-Test</h1>
        <p>This page will automatically test the main SleepApnea app for JavaScript errors and functionality.</p>
        
        <div id="test-results"></div>
        
        <h3>Console Log:</h3>
        <div id="console-log" class="log"></div>
        
        <h3>Manual Test Link:</h3>
        <p><a href="index.html" target="_blank">Open SleepApnea App</a></p>
    </div>

    <script>
        // Capture console logs
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        const consoleOutput = [];
        
        function logToDiv(type, message) {
            consoleOutput.push(`[${type.toUpperCase()}] ${new Date().toLocaleTimeString()}: ${message}`);
            document.getElementById('console-log').textContent = consoleOutput.join('\n');
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            logToDiv('log', args.join(' '));
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            logToDiv('error', args.join(' '));
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            logToDiv('warn', args.join(' '));
        };
        
        // Test results container
        const resultsDiv = document.getElementById('test-results');
        
        function addTestResult(name, status, message) {
            const div = document.createElement('div');
            div.className = `test-result ${status}`;
            div.innerHTML = `<strong>${name}:</strong> ${message}`;
            resultsDiv.appendChild(div);
        }
        
        // Test functions
        async function testBackendConnection() {
            try {
                const response = await fetch('http://localhost:8000/health');
                if (response.ok) {
                    const data = await response.json();
                    addTestResult('Backend Connection', 'pass', `Connected successfully - ${data.service}`);
                    return true;
                } else {
                    addTestResult('Backend Connection', 'fail', `HTTP ${response.status}`);
                    return false;
                }
            } catch (error) {
                addTestResult('Backend Connection', 'fail', `Error: ${error.message}`);
                return false;
            }
        }
        
        function testJavaScriptSyntax() {
            try {
                // Create iframe to load main page and check for errors
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.src = 'index.html';
                
                return new Promise((resolve) => {
                    let errorCount = 0;
                    let loadTimeout;
                    
                    // Listen for iframe load
                    iframe.onload = function() {
                        clearTimeout(loadTimeout);
                        setTimeout(() => {
                            if (errorCount === 0) {
                                addTestResult('JavaScript Syntax', 'pass', 'No JavaScript errors detected');
                                resolve(true);
                            } else {
                                addTestResult('JavaScript Syntax', 'fail', `${errorCount} JavaScript errors detected`);
                                resolve(false);
                            }
                            document.body.removeChild(iframe);
                        }, 2000); // Wait 2 seconds for any delayed errors
                    };
                    
                    iframe.onerror = function() {
                        clearTimeout(loadTimeout);
                        errorCount++;
                        addTestResult('JavaScript Syntax', 'fail', 'Failed to load main page');
                        resolve(false);
                        document.body.removeChild(iframe);
                    };
                    
                    // Global error handler for iframe
                    window.addEventListener('error', function(e) {
                        if (e.filename && e.filename.includes('index.html')) {
                            errorCount++;
                            console.error('JavaScript error detected:', e.message, 'at', e.filename, ':', e.lineno);
                        }
                    });
                    
                    // Timeout fallback
                    loadTimeout = setTimeout(() => {
                        addTestResult('JavaScript Syntax', 'warning', 'Test timed out - page may be slow to load');
                        resolve(false);
                        if (document.body.contains(iframe)) {
                            document.body.removeChild(iframe);
                        }
                    }, 10000);
                    
                    document.body.appendChild(iframe);
                });
            } catch (error) {
                addTestResult('JavaScript Syntax', 'fail', `Test error: ${error.message}`);
                return false;
            }
        }
        
        function testMediaRecorderSupport() {
            if (typeof MediaRecorder !== 'undefined') {
                addTestResult('MediaRecorder Support', 'pass', 'MediaRecorder API is available');
                
                // Test supported MIME types
                const mimeTypes = ['audio/wav', 'audio/webm', 'audio/mp4', 'audio/ogg'];
                const supported = mimeTypes.filter(type => MediaRecorder.isTypeSupported(type));
                
                if (supported.length > 0) {
                    addTestResult('Audio Recording Formats', 'pass', `Supported: ${supported.join(', ')}`);
                } else {
                    addTestResult('Audio Recording Formats', 'warning', 'No standard audio formats supported');
                }
                
                return true;
            } else {
                addTestResult('MediaRecorder Support', 'fail', 'MediaRecorder API not available in this browser');
                return false;
            }
        }
        
        function testNavigatorMediaDevices() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                addTestResult('getUserMedia Support', 'pass', 'Microphone access API available');
                return true;
            } else {
                addTestResult('getUserMedia Support', 'fail', 'Microphone access API not available');
                return false;
            }
        }
        
        function testFileAPISupport() {
            if (typeof FileReader !== 'undefined' && typeof FormData !== 'undefined') {
                addTestResult('File API Support', 'pass', 'File upload functionality available');
                return true;
            } else {
                addTestResult('File API Support', 'fail', 'File API not fully supported');
                return false;
            }
        }
        
        // Run all tests
        async function runAllTests() {
            console.log('Starting SleepApnea frontend tests...');
            
            addTestResult('Test Started', 'pass', new Date().toLocaleString());
            
            // Browser compatibility tests
            testMediaRecorderSupport();
            testNavigatorMediaDevices();
            testFileAPISupport();
            
            // Backend connection test
            await testBackendConnection();
            
            // JavaScript syntax test (load main page)
            await testJavaScriptSyntax();
            
            addTestResult('Test Completed', 'pass', new Date().toLocaleString());
            console.log('All tests completed!');
        }
        
        // Start tests when page loads
        window.onload = runAllTests;
    </script>
</body>
</html>